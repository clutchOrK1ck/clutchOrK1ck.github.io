---
import Layout from "./Layout.astro";
import { Image } from "astro:assets";
import SkillBadge from "../components/SkillBadge.astro";
import { ExternalLink } from "@lucide/astro";
import { Carousel } from "webcoreui/astro";

interface Props {
  projectId: string;
  title: string;
  description: string;
  startDate: Date;
  endDate?: Date;
  image: any;
  skills: string[];
  demoLink?: string;
  sourceLink?: string;
  itchLink?: string;
}

const {
  projectId,
  title,
  description,
  startDate,
  endDate,
  image,
  skills,
  demoLink,
  sourceLink,
  itchLink
} = Astro.props;

function formatPeriod(startDate: Date, endDate?: Date) {
  const options: Intl.DateTimeFormatOptions = {
    month: "short",
    year: "numeric",
  };

  const start = startDate.toLocaleDateString("en-US", options);

  // If no end date, keep existing behavior
  if (!endDate) return `${start} - Present`;

  // If same month + year, return only the start date
  const sameMonthAndYear =
    startDate.getFullYear() === endDate.getFullYear() &&
    startDate.getMonth() === endDate.getMonth();

  if (sameMonthAndYear) return start;

  const end = endDate.toLocaleDateString("en-US", options);
  return `${start} - ${end}`;
}

// Calculate project duration
function calculateDuration(startDate: Date, endDate?: Date) {
  const end = endDate || new Date();
  const months =
    (end.getFullYear() - startDate.getFullYear()) * 12 +
    (end.getMonth() - startDate.getMonth());

  if (months < 1) return "Less than a month";
  if (months === 1) return "1 month";
  if (months < 12) return `${months} months`;

  const years = Math.floor(months / 12);
  const remainingMonths = months % 12;

  if (remainingMonths === 0) return years === 1 ? "1 year" : `${years} years`;
  return `${years} year${years > 1 ? "s" : ""}, ${remainingMonths} month${remainingMonths > 1 ? "s" : ""}`;
}

// Project gallery (images and videos for the carousel of this project)
type GalleryItem =
  | { type: "image"; src: string}
  | { type: "video"; src: string};

const IMAGE_EXTENSIONS = [".png", ".jpg", ".jpeg"]
const VIDEO_EXTENSIONS = [".mp4"]

// dicover all media-files at build time
const ALL_MEDIA_FILES = import.meta.glob(
  "/public/project-galleries/**/*.{png,jpg,jpeg,mp4}",
  { eager: true, query: "?url", import: "default"}
) as Record<string, string>;

function readProjectGallery(projectId: string): GalleryItem[] {
  const prefix = `/public/project-galleries/${projectId}/`;

  return Object.entries(ALL_MEDIA_FILES)
    .filter(([filePath]) => filePath.startsWith(prefix))
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([filePath, url]) => {
      const lowerCaseFilePath = filePath.toLowerCase();
      const extension = lowerCaseFilePath.slice(lowerCaseFilePath.lastIndexOf("."));
      return {
        type: VIDEO_EXTENSIONS.includes(extension) ? "video" : "image",
        src: url.replace("/public", ""),
      };
    });
}

const projectGallery = readProjectGallery(projectId);
console.log("Extracted gallery for: ", projectId, ": ", projectGallery);
---

<Layout title={title} description={description}>
  <article class="max-w-4xl mx-auto px-4 py-20">
    <!-- Back button -->
    <div class="mb-8">
      <a href="/projects" class="btn btn-ghost btn-sm">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="m15 18-6-6 6-6"></path>
        </svg>
        Back to Projects
      </a>
    </div>

    <!-- Project gallery -->
    {
      projectGallery.length > 0 && (
        <div class="mb-8 rounded-2xl overflow-hidden">
          <Carousel items={projectGallery.length}>
            {projectGallery.map((item) => (
              <li class="w-full">
                <div class="aspect-video w-full overflow-hidden rounded-2xl bg-black">
                  {
                    item.type === "image" ? (
                      <img
                        src={item.src}
                        alt={title}
                        class="w-full h-full object-cover"
                      />
                    ) : (
                      <video
                        src={item.src}
                        class="w-full h-full object-cover"
                        controls
                        playsinline
                      />
                    )
                  }
                </div>
              </li>
            ))}
          </Carousel>
        </div>
      )
    }


    <!-- Project Header -->
    <header class="mb-8">
      <h1 class="text-5xl font-bold mb-4">{title}</h1>
      <p class="text-xl text-base-content/70 mb-6">{description}</p>

      <div
        class="flex flex-wrap items-center gap-4 text-sm text-base-content/60 mb-6"
      >
        <span class="font-semibold">{formatPeriod(startDate, endDate)}</span>
        <span>•</span>
        <span>{calculateDuration(startDate, endDate)}</span>
        {
          !endDate && (
            <>
              <span>•</span>
              <span class="badge badge-success badge-sm">Ongoing</span>
            </>
          )
        }
      </div>

      <!-- Prominent Action Buttons -->
      {
        (demoLink || sourceLink || itchLink
        ) && (
          <div class="flex flex-wrap gap-3 mb-6">
            {demoLink && (
              <a
                href={demoLink}
                target="_blank"
                rel="noopener noreferrer"
                class="btn btn-primary gap-2"
              >
                <ExternalLink class="size-5" />
                Live Demo
              </a>
            )}
            {sourceLink && (
              <a
                href={sourceLink}
                target="_blank"
                rel="noopener noreferrer"
                class="btn btn-soft gap-2"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 32 32"
                  fill="currentColor"
                >
                  <path d="M16,2.345c7.735,0,14,6.265,14,14-.002,6.015-3.839,11.359-9.537,13.282-.7,.14-.963-.298-.963-.665,0-.473,.018-1.978,.018-3.85,0-1.312-.437-2.152-.945-2.59,3.115-.35,6.388-1.54,6.388-6.912,0-1.54-.543-2.783-1.435-3.762,.14-.35,.63-1.785-.14-3.71,0,0-1.173-.385-3.85,1.435-1.12-.315-2.31-.472-3.5-.472s-2.38,.157-3.5,.472c-2.677-1.802-3.85-1.435-3.85-1.435-.77,1.925-.28,3.36-.14,3.71-.892,.98-1.435,2.24-1.435,3.762,0,5.355,3.255,6.563,6.37,6.913-.403,.35-.77,.963-.893,1.872-.805,.368-2.818,.963-4.077-1.155-.263-.42-1.05-1.452-2.152-1.435-1.173,.018-.472,.665,.017,.927,.595,.332,1.277,1.575,1.435,1.978,.28,.787,1.19,2.293,4.707,1.645,0,1.173,.018,2.275,.018,2.607,0,.368-.263,.787-.963,.665-5.719-1.904-9.576-7.255-9.573-13.283,0-7.735,6.265-14,14-14Z" />
                </svg>
                View Source
              </a>
            )}
            {itchLink && (
              <a
                href={itchLink}
                target="_blank"
                rel="noopener noreferrer"
                class="btn btn-primary gap-2"
              >
                <svg 
                  fill="currentColor" 
                  xmlns="http://www.w3.org/2000/svg" 
                  width="24" 
                  height="24" 
                  viewBox="924 796 200 200"
                >
                  <path d="M1123.719,924.018l0.059,0.02l-6.181-46.92c-0.128-1.528-0.327-3.035-0.597-4.517l-0.008-0.05v0.001
                    c-3.99-21.845-23.107-38.409-46.107-38.409c-0.297,0-0.59,0.015-0.885,0.022c-0.053-0.002-0.102-0.022-0.153-0.022h-91.692
                    c-0.053,0-0.102,0.02-0.155,0.022c-0.296-0.006-0.588-0.022-0.885-0.022c-22.999,0-42.117,16.564-46.107,38.409l-0.001-0.001
                    l-0.006,0.05c-0.27,1.482-0.469,2.988-0.595,4.517l-6.183,46.92l0.06-0.02c-0.166,1.278-0.281,2.571-0.281,3.896
                    c0,16.537,13.407,29.944,29.946,29.944c8.884,0,16.84-3.89,22.324-10.035l0.008,0.032c0,0,14.918-15.371,25.11-25.872
                    c5.945-6.125,14.118-9.582,22.654-9.582c8.483,0,16.602,3.434,22.509,9.521c10.193,10.503,25.169,25.934,25.169,25.934l0.01-0.032
                    c5.482,6.146,13.439,10.035,22.324,10.035c16.537,0,29.945-13.408,29.945-29.944C1124,926.589,1123.883,925.296,1123.719,924.018z
                    M997.156,886.363h-10.742c-1.479,0-2.677,1.199-2.677,2.677v10.744c0,3.657-2.964,6.621-6.621,6.621s-6.621-2.964-6.621-6.621
                    V889.04c0-1.479-1.198-2.677-2.677-2.677h-10.743c-3.656,0-6.621-2.964-6.621-6.621s2.964-6.621,6.621-6.621h10.744
                    c1.479,0,2.677-1.199,2.677-2.677v-10.742c0-3.657,2.964-6.62,6.62-6.62c3.656,0,6.621,2.963,6.621,6.62v10.742
                    c0,1.479,1.199,2.677,2.677,2.677h10.742c3.656,0,6.621,2.964,6.621,6.621S1000.812,886.363,997.156,886.363z M1049.34,887.268
                    c-4.156,0-7.525-3.37-7.525-7.526c0-4.156,3.369-7.525,7.525-7.525s7.525,3.37,7.525,7.525
                    C1056.865,883.898,1053.496,887.268,1049.34,887.268z M1068.056,853.501c4.155,0,7.526,3.37,7.526,7.525
                    c0,4.156-3.371,7.526-7.526,7.526s-7.526-3.37-7.526-7.526C1060.529,856.871,1063.9,853.501,1068.056,853.501z M1068.056,905.986
                    c-4.155,0-7.526-3.37-7.526-7.525c0-4.156,3.371-7.526,7.526-7.526c4.157,0,7.526,3.37,7.526,7.526
                    C1075.582,902.616,1072.213,905.986,1068.056,905.986z M1086.773,887.269c-4.158,0-7.526-3.37-7.526-7.525
                    c0-4.156,3.368-7.526,7.526-7.526c4.156,0,7.525,3.37,7.525,7.526C1094.299,883.899,1090.93,887.269,1086.773,887.269z"/>
                </svg>
                Play this game
              </a>
            )}
          </div>
        )
      }
    </header>

    <!-- Tech Stack Showcase -->
    {
      skills && skills.length > 0 && (
        <div class="card bg-base-200 mb-8">
          <div class="card-body">
            <h2 class="card-title text-lg mb-3">Tech Stack</h2>
            <div class="flex flex-wrap gap-2">
              {skills.map((skill) => (
                <SkillBadge skill={skill} />
              ))}
            </div>
          </div>
        </div>
      )
    }

    <!-- Divider -->
    <div class="divider"></div>

    <!-- Project Content -->
    <div class="prose prose-lg max-w-none">
      <slot />
    </div>

    <!-- Divider -->
    <div class="divider mt-12"></div>

    <!-- Back to projects link -->
    <div class="text-center mt-8">
      <a href="/projects" class="btn btn-primary"> View All Projects </a>
    </div>
  </article>
</Layout>

